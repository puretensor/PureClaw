apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus-local
  namespace: nexus-local
  labels:
    app: nexus-local
spec:
  replicas: 1
  strategy:
    type: Recreate  # Only one Telegram poller allowed
  selector:
    matchLabels:
      app: nexus-local
  template:
    metadata:
      labels:
        app: nexus-local
    spec:
      # Required on kernel 6.17-pve — AppArmor blocks socket creation otherwise
      securityContext:
        appArmorProfile:
          type: Unconfined
      initContainers:
        # Copy SSH keys from read-only Secret to writable emptyDir
        # Secret volumes are owned by root — container runs as uid 1000
        - name: setup-ssh
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /secrets/ssh/* /ssh-writable/
              chmod 700 /ssh-writable
              chmod 600 /ssh-writable/id_ed25519
              chmod 644 /ssh-writable/config
              touch /ssh-writable/known_hosts
              chmod 644 /ssh-writable/known_hosts
              chown -R 1000:1000 /ssh-writable
          volumeMounts:
            - name: ssh-keys
              mountPath: /secrets/ssh
              readOnly: true
            - name: ssh-writable
              mountPath: /ssh-writable

        # Fix PVC ownership (runs as root)
        - name: fix-db-perms
          image: busybox:1.36
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - chown -R 1000:1000 /data
          volumeMounts:
            - name: nexus-local-data
              mountPath: /data

      containers:
        - name: nexus-local
          image: nexus:v1.0.0
          imagePullPolicy: Never
          ports:
            - containerPort: 9876
              name: webhook
          envFrom:
            - secretRef:
                name: nexus-local-env
            - configMapRef:
                name: nexus-local-config
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /
              port: 9876
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /
              port: 9876
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
          volumeMounts:
            # Persistent data (SQLite DB, observer state)
            - name: nexus-local-data
              mountPath: /data
            # SSH keys (writable copy with correct ownership)
            - name: ssh-writable
              mountPath: /app/.ssh

      volumes:
        - name: nexus-local-data
          persistentVolumeClaim:
            claimName: nexus-local-data
        - name: ssh-keys
          secret:
            secretName: ssh-keys
            defaultMode: 0600
        - name: ssh-writable
          emptyDir: {}
